<!DOCTYPE html>  <html> <head>   <title>poptags.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               poptags.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>is the declarative template engine built for <a href="http://www.webpop.com">Webpop</a>.</p>

<p>PopTags takes a third approach to templating.</p>

<p>Some template engines lets people do programming in the templates, either by
allowing the use of a programming language or by defining a programming language
for the template engine with if statements, loops, etc.</p>

<p>Other template engines aims for a strict separation of templates and logic, and
force any presentational login into separate files.</p>

<p>PopTags takes a declarative approach. There's no explicit loop constructs, no if
statements, and no programming like constructs, but there's still plenty of room
to define presentational logic in a declarative way and templates can pull in
external libraries exposed to the engine and use them as it sees fit.</p>

<h3>Usage</h3>

<pre><code>template = new PopTags.Template {
  template: "&lt;pop:title wrap='h1'/&gt;"
}
html = template.render {
  title: "Hello, World!"
}
html == "&lt;h1&gt;Hello, World!&lt;/h1&gt;"
</code></pre>

<h3>Reading Includes and Layouts</h3>

<p>The <em>read</em> function are used for looking up templates when using <code>&lt;pop:include&gt;</code> or <code>&lt;pop:layout&gt;</code>:</p>

<pre><code>templates = {
  main: "&lt;pop:include template='partial'/&gt;"
  partial: "&lt;pop:title wrap='h1'/&gt;
}

read = (name) -&gt; templates[name]

template = new PopTags.Template {
  read: read
  name: "main"
}
html = template.render {
  title: "Hello, World!"
}
html == "&lt;h1&gt;Hello, World!&lt;/h1&gt;"
</code></pre>

<h3>Filters</h3>

<p>PopTags allow you to define filters that can be applied via attributes.</p>

<pre><code>filters = {
  format: (value, options) -&gt;
    switch options.format
      when "upcase"
        value.toUpperCase()
      when "downcase"
        value.toLowerCase()
}

template = new PopTags.Template {
  template: "&lt;pop:title format='upcase' wrap='h1' /&gt;"
  filters: filters
}
html = template.render {
  title: "Hello, World!
}
html == "&lt;h1&gt;HELLO, WORLD!&lt;/h1&gt;"
</code></pre>

<h1>Pulling in CommonJS modules</h1>

<p>The <em>require</em> function are used for dynamically pulling in CommonJS and use their exported methods as tags:</p>

<pre><code>modules = {
  hello:
    world: (options, enclosed, tags) -&gt; "Hello, World!"
}

require = (name) -&gt; modules[name]

template = new PopTags.Template {
  template: "&lt;pop:hello:world wrap='h1'/&gt;"
  require: require
 }
 html = template.render()
 html == "&lt;h1&gt;Hello, World!&lt;/h1&gt;"
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Regular Expressions and delimiters used by the parser</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">CONSTANTS =</span>
  <span class="nv">LAYOUT_TAG: </span>      <span class="s">&#39;layout&#39;</span>
  <span class="nv">INCLUDE_TAG: </span>     <span class="s">&#39;include&#39;</span>
  <span class="nv">REGION_TAG: </span>      <span class="s">&#39;region&#39;</span>
  <span class="nv">BLOCK_TAG: </span>       <span class="s">&#39;block&#39;</span>
  <span class="nv">START_TAG_RE: </span>    <span class="sr">/^&lt;pop:(\w+[a-zA-Z0-9_:\.-]*)((?:\s+\w+(?:\s*=\s*(?:(?:&quot;[^&quot;]*&quot;)|(?:&#39;[^&#39;]*&#39;)))?)*)\s*\/?&gt;/</span>
  <span class="nv">END_TAG_RE: </span>      <span class="sr">/^&lt;\/pop:(\w+[a-zA-Z0-9_:\.-]*)\s*&gt;/</span>
  <span class="nv">SELF_CLOSING_RE: </span> <span class="sr">/\/&gt;$/m</span>
  <span class="nv">ATTRIBUTES_RE: </span>   <span class="sr">/(\w+)(?:\s*=\s*(?:(?:&quot;((?:\\.|[^&quot;])*)&quot;)|(?:&#39;((?:\\.|[^&#39;])*)&#39;)))/g</span>
  <span class="nv">START_TAG: </span>       <span class="s">&quot;&lt;pop:&quot;</span>
  <span class="nv">END_TAG: </span>         <span class="s">&quot;&lt;/pop:&quot;</span>
  <span class="nv">COMMENT_TAG: </span>     <span class="s">&quot;&lt;!--&quot;</span>
  <span class="nv">COMMENT_TAG_END: </span> <span class="s">&quot;--&gt;&quot;</span>
  <span class="nv">CONTAINS_TAGS_RE: </span><span class="sr">/&lt;pop:/</span>
  <span class="nv">COLLECTION_HELPER_TAGS: </span><span class="p">[</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;last&#39;</span><span class="p">,</span> <span class="s">&#39;odd&#39;</span><span class="p">,</span> <span class="s">&#39;even&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Tags that should be selfclosing when used in a break attribute</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">SELF_CLOSING:</span>
    <span class="nv">br: </span><span class="kc">true</span>
    <span class="nv">hr: </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>What follows are a few small helper functions used in various parts of the engine</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">escapeHtml = </span><span class="nf">(html) -&gt;</span>
  <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;/gmi</span><span class="p">,</span> <span class="s">&#39;&amp;amp;&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&#39;/gmi</span><span class="p">,</span> <span class="s">&#39;&amp;#x27;&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/gmi</span><span class="p">,</span> <span class="s">&#39;&amp;quot;&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/gmi</span><span class="p">,</span> <span class="s">&#39;&amp;gt;&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/gmi</span><span class="p">,</span> <span class="s">&#39;&amp;lt;&#39;</span><span class="p">)</span>


<span class="nv">wrap = </span><span class="nf">(text, tag, klass) -&gt;</span>
  <span class="k">return</span> <span class="nx">text</span> <span class="nx">unless</span> <span class="nx">tag</span> <span class="o">&amp;&amp;</span> <span class="nx">text</span>

  <span class="nv">result = </span><span class="s">&quot;&lt;</span><span class="si">#{</span><span class="nx">tag</span><span class="si">}</span><span class="s">&quot;</span>
  <span class="nx">result</span> <span class="o">+=</span> <span class="s">&quot; class=\&quot;</span><span class="si">#{</span><span class="nx">klass</span><span class="si">}</span><span class="s">\&quot;&quot;</span> <span class="k">if</span> <span class="nx">klass</span>
  <span class="k">return</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">result</span><span class="si">}</span><span class="s">&gt;</span><span class="si">#{</span><span class="nx">text</span><span class="si">}</span><span class="s">&lt;/</span><span class="si">#{</span><span class="nx">tag</span><span class="si">}</span><span class="s">&gt;&quot;</span>

<span class="nv">breakFn = </span><span class="nf">(c, separator, last) -&gt;</span>
  <span class="k">return</span> <span class="nx">separateFn</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">separator</span><span class="p">,</span> <span class="nx">last</span><span class="p">)</span> <span class="nx">unless</span> <span class="p">(</span><span class="sr">/^[a-zA-Z]+$/</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">separator</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">separateFn</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="s">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">separator</span> <span class="o">+</span> <span class="s">&#39; /&gt;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">SELF_CLOSING</span><span class="p">[</span><span class="nx">separator</span><span class="p">]</span>
  <span class="nx">delimitFn</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">separator</span> <span class="o">+</span> <span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;/&#39;</span> <span class="o">+</span> <span class="nx">separator</span> <span class="o">+</span> <span class="s">&#39;&gt;&#39;</span><span class="p">)</span>

<span class="nv">separateFn = </span><span class="nf">(c, separator, last) -&gt;</span>
  <span class="nv">end = </span><span class="nx">c</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>

  <span class="nf">(value, index) -&gt;</span>
    <span class="nv">separator = </span><span class="nx">last</span> <span class="o">||</span> <span class="nx">separator</span> <span class="k">if</span> <span class="nx">index</span> <span class="o">==</span> <span class="nx">end</span>
    <span class="k">if</span> <span class="nx">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">value</span> <span class="k">else</span> <span class="nx">separator</span> <span class="o">+</span> <span class="nx">value</span>

<span class="nv">delimitFn = </span><span class="nf">(open, close) -&gt;</span>
  <span class="nx">open</span>  <span class="o">||=</span> <span class="s">&#39;&#39;</span>
  <span class="nx">close</span> <span class="o">||=</span> <span class="s">&#39;&#39;</span>

  <span class="nf">(value) -&gt;</span> <span class="nx">open</span> <span class="o">+</span> <span class="nx">value</span> <span class="o">+</span> <span class="nx">close</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The Exception Class thrown by the parser</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">TemplateError</span> <span class="k">extends</span> <span class="nb">Error</span>
  <span class="nv">constructor: </span><span class="nf">(message, location, filename) -&gt;</span>
    <span class="vi">@name     = </span><span class="s">&quot;TemplateError&quot;</span>
    <span class="vi">@message  = </span><span class="nx">message</span>
    <span class="vi">@location = </span><span class="nx">location</span>
    <span class="vi">@filename = </span><span class="nx">filename</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3>Ast</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The Ast class is used internally to build up the tree of nodes during parsing
It takes a require function (used for resolving extensions), a filters function
(used to resolve any attribute based filters) and an optional value<em>wrapper.
If the value</em>wrapper is present, any value the template engine is about to
render will be passed through the value wrapper first.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Ast</span>
  <span class="nv">constructor: </span><span class="nf">(@require, @filters, @value_wrapper) -&gt;</span>
    <span class="vi">@root        = </span><span class="k">new</span> <span class="nx">EnclosingTag</span>
    <span class="vi">@current_tag = </span><span class="nx">@root</span>
    <span class="vi">@layout      = </span><span class="kc">null</span>
    <span class="vi">@includes    = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Called at the beginning of the document</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">start_document: </span><span class="nf">(parser) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Called when the parsing is over</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">end_document: </span><span class="nf">(parser) -&gt;</span>
    <span class="k">if</span> <span class="nx">@current_tag</span> <span class="o">==</span> <span class="nx">@root</span>
      <span class="nx">@_handle_layout</span><span class="p">(</span><span class="nx">parser</span><span class="p">,</span> <span class="nx">@layout</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@layout</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@current_tag</span><span class="p">.</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">@current_tag</span><span class="p">.</span><span class="nx">include_tag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">@current_tag</span><span class="p">.</span><span class="nx">layout_tag</span>
      <span class="nx">@no_closing_tag</span><span class="p">(</span><span class="nx">parser</span><span class="p">,</span> <span class="nx">@current_tag</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Called each time the parser encounters a start tag</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">start_tag: </span><span class="nf">(parser, name, options) -&gt;</span>
    <span class="nv">new_tag = </span><span class="k">new</span> <span class="nx">Tag</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">@current_tag</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">@require</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
    <span class="nv">new_tag.value_wrapper = </span><span class="nx">@value_wrapper</span>
    <span class="nv">new_tag.position = </span><span class="nx">parser</span><span class="p">.</span><span class="nx">position</span>

    <span class="k">if</span> <span class="nx">name</span> <span class="o">==</span> <span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">BLOCK_TAG</span>
      <span class="nx">@block_tag_without_layout</span><span class="p">(</span><span class="nx">parser</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">@layout</span>
      <span class="nx">@layout</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">region</span><span class="p">]</span> <span class="o">=</span> <span class="nx">new_tag</span>
      <span class="vi">@current_tag = </span><span class="nx">new_tag</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">name</span> <span class="o">==</span> <span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">LAYOUT_TAG</span>
        <span class="nx">@layout_already_defined</span><span class="p">(</span><span class="nx">parser</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@layout</span>
        <span class="vi">@layout = </span><span class="nx">new_tag</span>
      <span class="k">if</span> <span class="nx">options</span> <span class="o">and</span> <span class="nx">@filters</span>
        <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">_</span> <span class="k">of</span> <span class="nx">options</span>
          <span class="nx">new_tag</span><span class="p">.</span><span class="nx">add_filter</span><span class="p">(</span><span class="nx">@filters</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="k">if</span> <span class="nx">@filters</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="nx">@current_tag</span><span class="p">.</span><span class="nx">push</span> <span class="nx">new_tag</span>
      <span class="vi">@current_tag = </span><span class="nx">new_tag</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Called each time the parser encounters an end tag</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">end_tag: </span><span class="nf">(parser, name) -&gt;</span>
    <span class="k">while</span> <span class="o">not</span> <span class="nx">@current_tag</span><span class="p">.</span><span class="nx">is_closing</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
      <span class="vi">@current_tag = </span><span class="nx">@current_tag</span><span class="p">.</span><span class="nx">parent</span>
      <span class="nx">unless</span> <span class="nx">@current_tag</span> <span class="o">&amp;&amp;</span> <span class="nx">@current_tag</span><span class="p">.</span><span class="nx">parent</span>
        <span class="nx">@unmatched_closing_tag</span><span class="p">(</span><span class="nx">parser</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">name</span> <span class="o">==</span> <span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">INCLUDE_TAG</span>
      <span class="nx">@_handle_include</span><span class="p">(</span><span class="nx">parser</span><span class="p">,</span> <span class="nx">@current_tag</span><span class="p">)</span>

    <span class="vi">@current_tag = </span><span class="nx">@current_tag</span><span class="p">.</span><span class="nx">parent</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Called for anything that's not part of a pop:tag</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">text: </span><span class="nf">(parser, text) -&gt;</span>
    <span class="nx">@current_tag</span><span class="p">.</span><span class="nx">push</span> <span class="nx">text</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Include handler. If possible we parse the included
template straight away, but if the template attribute
contains pop:tag we have to defer the parsing until
render-time</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_handle_include: </span><span class="nf">(parser, include_tag) -&gt;</span>
    <span class="nv">template_name = </span><span class="nx">include_tag</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span>
    <span class="nv">template      = </span><span class="nx">@includes</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span>

    <span class="k">if</span> <span class="nx">template_name</span><span class="p">.</span><span class="nx">render</span>
      <span class="nv">include_tag.read    = </span><span class="nx">parser</span><span class="p">.</span><span class="nx">read</span>
      <span class="nv">include_tag.require = </span><span class="nx">@require</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">template</span>
      <span class="nv">include_tag.enclosing = </span><span class="nx">template</span><span class="p">.</span><span class="nx">enclosing</span>
    <span class="k">else</span>
      <span class="nx">@includes</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">include_tag</span>
      <span class="k">new</span> <span class="nx">Parser</span><span class="p">(</span><span class="nx">parser</span><span class="p">.</span><span class="nx">read</span><span class="p">).</span><span class="nx">parse</span><span class="p">(</span><span class="nx">parser</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">template_name</span><span class="p">),</span> <span class="k">this</span><span class="p">,</span> <span class="nx">template_name</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Layout handler. Just as with includes we defer parsing of the layout if the 
layout attribute contains pop:tags</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_handle_layout: </span><span class="nf">(parser, layout) -&gt;</span>
    <span class="nv">layout_name = </span><span class="nx">layout</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span>

    <span class="k">if</span> <span class="nx">layout_name</span><span class="p">.</span><span class="nx">render</span>
      <span class="nv">layout.read    = </span><span class="nx">parser</span><span class="p">.</span><span class="nx">read</span>
      <span class="nv">layout.require = </span><span class="nx">@require</span>
    <span class="k">else</span>
      <span class="vi">@current_tag = </span><span class="nx">layout</span>
      <span class="k">new</span> <span class="nx">Parser</span><span class="p">(</span><span class="nx">parser</span><span class="p">.</span><span class="nx">read</span><span class="p">).</span><span class="nx">parse</span><span class="p">(</span><span class="nx">parser</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="s">&quot;layouts/</span><span class="si">#{</span><span class="nx">layout_name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">),</span> <span class="k">this</span><span class="p">,</span> <span class="s">&quot;layouts/</span><span class="si">#{</span><span class="nx">layout_name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Error handlers for malformed templates</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unmatched_closing_tag: </span><span class="nf">(parser, name) -&gt;</span>
    <span class="k">throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">TemplateError</span><span class="p">(</span><span class="s">&quot;closing tag &lt;/pop:</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&gt; did not match any opening tag&quot;</span><span class="p">,</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">get_location</span><span class="p">(),</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">filename</span><span class="p">))</span>

  <span class="nv">no_closing_tag: </span><span class="nf">(parser, name) -&gt;</span>
    <span class="k">throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">TemplateError</span><span class="p">(</span><span class="s">&quot;no closing tag for &lt;pop:</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&gt;&quot;</span><span class="p">,</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">get_location</span><span class="p">(</span><span class="nx">@current_tag</span><span class="p">.</span><span class="nx">position</span><span class="p">),</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">filename</span><span class="p">))</span>

  <span class="nv">block_tag_without_layout: </span><span class="nf">(parser, name) -&gt;</span>
    <span class="k">throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">TemplateError</span><span class="p">(</span><span class="s">&quot;block tag without layout&quot;</span><span class="p">,</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">get_location</span><span class="p">(),</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">filename</span><span class="p">))</span>

  <span class="nv">layout_already_defined: </span><span class="nf">(parser, name) -&gt;</span>
    <span class="k">throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">TemplateError</span><span class="p">(</span><span class="s">&quot;layout already defined&quot;</span><span class="p">,</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">get_location</span><span class="p">(),</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">filename</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h3>Parser</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The parser is instantiated with a <em>read</em> function that should take
a name and return the contents of a template.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Parser</span>
  <span class="nv">constructor: </span><span class="nf">(read) -&gt;</span>
    <span class="vi">@read = </span><span class="nx">read</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Helper function to find the closest relevant tag given
indices of the next start tag, the next end tag and the
next comment.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">next_tag_index: </span><span class="nf">(next_start, next_end, next_comment) -&gt;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nx">next_start</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">next_end</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">next_comment</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span>
      <span class="k">if</span> <span class="nx">next_start</span>   <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="kc">Infinity</span> <span class="k">else</span> <span class="nx">next_start</span><span class="p">,</span>
      <span class="k">if</span> <span class="nx">next_end</span>     <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="kc">Infinity</span> <span class="k">else</span> <span class="nx">next_end</span><span class="p">,</span>
      <span class="k">if</span> <span class="nx">next_comment</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="kc">Infinity</span> <span class="k">else</span> <span class="nx">next_comment</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Find the line number of a position in a template</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_line_number: </span><span class="nf">(template, position) -&gt;</span>
    <span class="nv">newlines = </span><span class="nx">template</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">position</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">newlines</span> <span class="k">then</span> <span class="nx">newlines</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Get the character count of the current line for a 
given template and position.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_character: </span><span class="nf">(template, line_number, position) -&gt;</span>
    <span class="nx">template</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n/</span><span class="p">)[</span><span class="mi">0</span><span class="p">..</span><span class="nx">line_number</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">).</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Convert a position to a location ({line: <int>, character: <int>})</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_location: </span><span class="nf">(position) -&gt;</span>
    <span class="nv">line_number = </span><span class="nx">@get_line_number</span><span class="p">(</span><span class="nx">@template</span><span class="p">,</span> <span class="nx">position</span> <span class="o">||</span> <span class="nx">@position</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nv">line: </span><span class="nx">line_number</span>
      <span class="nv">character: </span><span class="nx">@get_character</span><span class="p">(</span><span class="nx">@template</span><span class="p">,</span> <span class="nx">line_number</span><span class="p">,</span> <span class="nx">position</span> <span class="o">||</span> <span class="nx">@position</span><span class="p">)</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Parse a template with a handler. Errors are reported with a location and the
relevant filename.
The handler should respond to: start<em>document, end</em>document, start<em>tag, end</em>tag and text</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parse: </span><span class="nf">(template, handler, filename) -&gt;</span>
    <span class="nv">parser = </span><span class="k">this</span>
    <span class="nv">template_chunk = </span><span class="nx">template</span>
    <span class="nv">offset = </span><span class="mi">0</span>

    <span class="vi">@template = </span><span class="nx">template</span>
    <span class="vi">@filename = </span><span class="nx">filename</span>
    <span class="vi">@position = </span><span class="mi">0</span>

    <span class="nx">handler</span><span class="p">.</span><span class="nx">start_document</span><span class="p">(</span><span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>consume all of the given template in chuncks</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="nx">template_chunk</span>
      <span class="nv">tag_match = </span><span class="kc">null</span>

      <span class="k">if</span> <span class="nx">template_chunk</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">COMMENT_TAG</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="nv">tag_match = </span><span class="kc">true</span>
        <span class="nv">next_tag_index = </span><span class="nx">template_chunk</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">COMMENT_TAG_END</span><span class="p">)</span>
        <span class="nv">text = </span><span class="k">if</span> <span class="nx">next_tag_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">template_chunk</span> <span class="k">else</span> <span class="nx">template_chunk</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">next_tag_index</span><span class="p">)</span>
        <span class="nx">handler</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span>
        <span class="nv">offset = </span><span class="k">if</span> <span class="nx">next_tag_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">template_chunk</span><span class="p">.</span><span class="nx">length</span> <span class="k">else</span> <span class="nx">next_tag_index</span>

      <span class="k">else</span> <span class="k">if</span> <span class="nx">template_chunk</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">START_TAG</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="nx">unless</span> <span class="nv">tag_match = </span><span class="nx">template_chunk</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">START_TAG_RE</span><span class="p">)</span>
          <span class="k">throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">TemplateError</span><span class="p">(</span><span class="s">&quot;syntax error&quot;</span><span class="p">,</span> <span class="nx">@get_location</span><span class="p">(),</span> <span class="nx">@filename</span><span class="p">))</span>

        <span class="nv">tags           = </span><span class="kc">null</span>
        <span class="nv">options        = </span><span class="p">{}</span>
        <span class="nv">tag_name       = </span><span class="nx">tag_match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">tag_attributes = </span><span class="nx">tag_match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="nx">tag_name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>
          <span class="nv">tags = </span><span class="nx">tag_name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
          <span class="nv">tag_name = </span><span class="nx">tags</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
          <span class="nx">handler</span><span class="p">.</span><span class="nx">start_tag</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">tag</span><span class="p">,</span> <span class="p">{})</span>  <span class="k">for</span> <span class="nx">tag</span> <span class="k">in</span> <span class="nx">tags</span>

        <span class="k">if</span> <span class="nx">tag_attributes</span>
          <span class="nx">tag_attributes</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">ATTRIBUTES_RE</span><span class="p">,</span> <span class="nf">(match, name, doublequoted_value, singlequoted_value) -&gt;</span>
            <span class="nv">value = </span><span class="nx">doublequoted_value</span> <span class="o">or</span> <span class="nx">singlequoted_value</span>
            <span class="k">if</span> <span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">CONTAINS_TAGS_RE</span><span class="p">)</span>
              <span class="nx">options</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Template</span><span class="p">({</span><span class="nv">template: </span><span class="nx">value</span><span class="p">,</span> <span class="nv">filters: </span><span class="nx">handler</span><span class="p">.</span><span class="nx">filters</span><span class="p">,</span> <span class="nv">read: </span><span class="nx">@read</span><span class="p">,</span> <span class="nv">require: </span><span class="nx">handler</span><span class="p">.</span><span class="nx">require</span><span class="p">}).</span><span class="nx">compile</span><span class="p">()</span>
              <span class="nx">options</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nv">parent = </span><span class="nx">handler</span><span class="p">.</span><span class="nx">current_tag</span>
            <span class="k">else</span>
              <span class="nx">options</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

        <span class="nx">handler</span><span class="p">.</span><span class="nx">start_tag</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">tag_name</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>

        <span class="nv">offset = </span><span class="nx">tag_match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span>
        <span class="k">if</span> <span class="nx">tag_match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">SELF_CLOSING_RE</span><span class="p">)</span>
          <span class="nx">handler</span><span class="p">.</span><span class="nx">end_tag</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">tag_name</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">tags</span>
            <span class="k">while</span> <span class="nv">tag = </span><span class="nx">tags</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
              <span class="nx">handler</span><span class="p">.</span><span class="nx">end_tag</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">tag</span><span class="p">)</span>

      <span class="k">else</span> <span class="k">if</span> <span class="nx">template_chunk</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">END_TAG</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="nv">tag_match = </span><span class="nx">template_chunk</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">END_TAG_RE</span><span class="p">)</span>
        <span class="k">throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">TemplateError</span><span class="p">(</span><span class="s">&quot;syntax error&quot;</span><span class="p">,</span> <span class="nx">@get_location</span><span class="p">(),</span> <span class="nx">@filename</span><span class="p">))</span> <span class="nx">unless</span> <span class="nx">tag_match</span>

        <span class="nv">tags = </span><span class="kc">null</span>
        <span class="nv">tag_name = </span><span class="nx">tag_match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">tag_name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
          <span class="nv">tags = </span><span class="nx">tag_name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
          <span class="nv">tag_name = </span><span class="nx">tags</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>

        <span class="nx">handler</span><span class="p">.</span><span class="nx">end_tag</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">tag_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">tags</span>
          <span class="k">while</span> <span class="nv">tag = </span><span class="nx">tags</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
            <span class="nx">handler</span><span class="p">.</span><span class="nx">end_tag</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">tag</span><span class="p">)</span>

        <span class="nv">offset = </span><span class="nx">tag_match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span>

      <span class="nx">unless</span> <span class="nx">tag_match</span>
        <span class="nv">next_tag_index = </span><span class="nx">@next_tag_index</span><span class="p">(</span>
          <span class="nx">template_chunk</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">START_TAG</span><span class="p">),</span>
          <span class="nx">template_chunk</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">END_TAG</span><span class="p">),</span>
          <span class="nx">template_chunk</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">COMMENT_TAG</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nv">text = </span><span class="k">if</span> <span class="nx">next_tag_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">template_chunk</span> <span class="k">else</span> <span class="nx">template_chunk</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">next_tag_index</span><span class="p">)</span>
        <span class="nx">handler</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span>
        <span class="nv">offset = </span><span class="k">if</span> <span class="nx">next_tag_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">template_chunk</span><span class="p">.</span><span class="nx">length</span> <span class="k">else</span> <span class="nx">next_tag_index</span>
      <span class="k">throw</span><span class="p">(</span><span class="k">new</span> <span class="nx">TemplateError</span><span class="p">(</span><span class="s">&quot;syntax error&quot;</span><span class="p">,</span> <span class="nx">@get_location</span><span class="p">(),</span> <span class="nx">@filename</span><span class="p">))</span> <span class="k">if</span> <span class="nx">offset</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nx">@position</span> <span class="o">+=</span> <span class="nx">offset</span>
      <span class="nv">template_chunk = </span><span class="nx">template_chunk</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span>

    <span class="nx">handler</span><span class="p">.</span><span class="nx">end_document</span><span class="p">(</span><span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h3>Ast Nodes</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Node is the superclass of the Nodes in the AST.
All nodes should implement <em>render</em> and <em>push</em></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Node</span>
  <span class="nv">render: </span><span class="o">-&gt;</span>
  <span class="nv">push: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>An enclosingtag holds a collection of nodes and strings.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">EnclosingTag</span> <span class="k">extends</span> <span class="nx">Node</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@collection = </span><span class="p">[]</span>
    <span class="vi">@lastEmpty = </span><span class="kc">null</span>

  <span class="nv">render: </span><span class="nf">(scope) -&gt;</span>
    <span class="vi">@scope = </span><span class="nx">scope</span>
    <span class="nv">rendered_children = </span><span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">@collection</span>
      <span class="k">if</span> <span class="nx">child</span><span class="p">.</span><span class="nx">render</span><span class="o">?</span> <span class="k">then</span> <span class="nx">child</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">scope</span><span class="p">)</span> <span class="k">else</span> <span class="nx">child</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="nx">rendered_children</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>

  <span class="nv">push: </span><span class="nf">(obj) -&gt;</span>
    <span class="nv">obj.index = </span><span class="nx">@collection</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">@collection</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span>

  <span class="nv">is_empty: </span><span class="o">-&gt;</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>

  <span class="nv">is_closing: </span><span class="o">-&gt;</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>A pop:tag node.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Tag</span> <span class="k">extends</span> <span class="nx">Node</span>
  <span class="nv">constructor: </span><span class="nf">(name, parent, options, require, ast) -&gt;</span>
    <span class="nv">route  = </span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
    <span class="vi">@qualified_name = </span><span class="nx">name</span>
    <span class="vi">@name           = </span><span class="nx">route</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="vi">@module         = </span><span class="nx">route</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>

    <span class="nv">no_tag = </span><span class="nx">@name</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^not?_(.+)/</span><span class="p">)</span>

    <span class="vi">@module_scope   = </span><span class="p">{}</span>
    <span class="vi">@filters        = </span><span class="p">[]</span>
    <span class="vi">@enclosing      = </span><span class="k">new</span> <span class="nx">EnclosingTag</span>
    <span class="vi">@blocks         = </span><span class="p">{}</span>
    <span class="vi">@parent         = </span><span class="nx">parent</span>
    <span class="vi">@options        = </span><span class="nx">options</span> <span class="o">||</span> <span class="p">{}</span>
    <span class="vi">@require        = </span><span class="nx">require</span>
    <span class="vi">@ast            = </span><span class="nx">ast</span>
    <span class="vi">@no_tag         = </span><span class="nx">no_tag</span> <span class="o">&amp;&amp;</span> <span class="k">if</span> <span class="nx">@module</span> <span class="k">then</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@module</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">no_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">else</span> <span class="nx">no_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="vi">@include_tag    = </span><span class="nx">@qualified_name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">INCLUDE_TAG</span>
    <span class="vi">@region_tag     = </span><span class="nx">@qualified_name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">REGION_TAG</span>
    <span class="vi">@block_tag      = </span><span class="nx">@qualified_name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">BLOCK_TAG</span>
    <span class="vi">@layout_tag     = </span><span class="nx">@qualified_name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">LAYOUT_TAG</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Adds a child node</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">push: </span><span class="nf">(obj) -&gt;</span> <span class="nx">@enclosing</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span>

  <span class="nv">is_closing: </span><span class="nf">(name) -&gt;</span> <span class="nx">name</span> <span class="o">==</span> <span class="nx">@qualified_name</span>

  <span class="nv">has_children: </span><span class="o">-&gt;</span> <span class="nx">@enclosing</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>

  <span class="nv">add_filter: </span><span class="nf">(filter) -&gt;</span> <span class="nx">@filters</span><span class="p">.</span><span class="nx">push</span> <span class="nx">filter</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>The @options holds the attributes. This helper method
makes sure any option that contains pop:tags is rendered
with the current scope when used.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_option: </span><span class="nf">(name) -&gt;</span>
    <span class="nv">opt = </span><span class="nx">@options</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">opt</span> <span class="o">and</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">render</span> <span class="k">then</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">@scope</span><span class="p">)</span> <span class="k">else</span> <span class="nx">opt</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Resolve the <pop:block> this tag is inside (if any)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_block: </span><span class="o">-&gt;</span>
    <span class="nv">tag = </span><span class="k">this</span>
    <span class="k">while</span> <span class="o">not</span> <span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">blocks</span> <span class="o">&amp;&amp;</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">@options</span><span class="p">.</span><span class="nx">name</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">parent</span>
      <span class="nv">tag = </span><span class="nx">tag</span><span class="p">.</span><span class="nx">parent</span>

    <span class="nx">tag</span><span class="p">.</span><span class="nx">blocks</span> <span class="o">&amp;&amp;</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">@options</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Get the value this tag should render by looking up the tag name in the scope.
The lookup travels up the AST tree until it finds a match or runs out of 
parent nodes. If a value wrapper is present, the value is passed through its
<em>wrap</em> method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_value: </span><span class="o">-&gt;</span>
    <span class="vi">@module_scope = </span><span class="nx">@require</span><span class="p">(</span><span class="nx">@module</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@module</span>

    <span class="nv">tag = </span><span class="k">this</span>
    <span class="k">while</span> <span class="o">not</span> <span class="p">(</span><span class="nx">@name</span> <span class="k">of</span> <span class="nx">@module_scope</span> <span class="o">||</span> <span class="nx">@name</span> <span class="k">of</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">scope</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">scope</span><span class="p">)</span>
      <span class="nv">tag = </span><span class="nx">tag</span><span class="p">.</span><span class="nx">parent</span>

    <span class="vi">@_tag_fn_scope = </span><span class="nx">tag</span><span class="p">.</span><span class="nx">scope</span>
    <span class="k">if</span> <span class="nx">@value_wrapper</span>
      <span class="nx">@value_wrapper</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">@module_scope</span><span class="p">[</span><span class="nx">@name</span><span class="p">]</span> <span class="o">||</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">@name</span><span class="p">],</span> <span class="k">this</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@module_scope</span><span class="p">[</span><span class="nx">@name</span><span class="p">]</span> <span class="o">||</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">@name</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Get the defalt value for this tag</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">default_value: </span><span class="o">-&gt;</span>
    <span class="nv">def = </span><span class="nx">@get_option</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">def</span> <span class="k">if</span> <span class="nx">def</span>

    <span class="vi">@parent.last_empty = </span><span class="nx">@qualified_name</span>
    <span class="s">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Get a list of child tags. An optional filter function can be supplied.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">tags: </span><span class="nf">(filter) -&gt;</span>
    <span class="nv">tags = </span><span class="p">[]</span>
    <span class="k">if</span> <span class="nx">filter</span>
      <span class="nx">tag</span> <span class="k">for</span> <span class="nx">tag</span> <span class="k">in</span> <span class="nx">@enclosing</span><span class="p">.</span><span class="nx">collection</span> <span class="k">when</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">render</span> <span class="o">and</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">tag</span> <span class="k">for</span> <span class="nx">tag</span> <span class="k">in</span> <span class="nx">@enclosing</span><span class="p">.</span><span class="nx">collection</span>
  </pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>This method make sure that all keys in the option that are in reality
nested poptags templates get rendered.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render_options: </span><span class="o">-&gt;</span>
    <span class="nv">options = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">@options</span>
      <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@get_option</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>

    <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Render a collection. If the tag value in the scope value is a collection
the tag will be rendered for each value in the collection</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render_collection: </span><span class="nf">(c) -&gt;</span>
    <span class="k">return</span> <span class="s">&quot;&quot;</span> <span class="nx">unless</span> <span class="nx">c</span><span class="p">.</span><span class="nx">length</span>

    <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">repeat</span> <span class="o">==</span> <span class="s">&quot;false&quot;</span>
      <span class="k">return</span> <span class="nx">@enclosing</span><span class="p">.</span><span class="nx">render</span>
        <span class="nv">length: </span><span class="nx">c</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">values: </span><span class="nx">c</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nf">(options, enclosing) -&gt;</span>
          <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">skip</span> <span class="o">or</span> <span class="nx">options</span><span class="p">.</span><span class="nx">limit</span>
            <span class="nv">skip  = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">skip</span>  <span class="k">then</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">skip</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="nv">limit = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">limit</span> <span class="k">then</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">limit</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">else</span> <span class="nx">c</span><span class="p">.</span><span class="nx">length</span>
            <span class="nx">c</span><span class="p">[</span><span class="nx">skip</span><span class="p">...(</span><span class="nx">skip</span><span class="o">+</span><span class="nx">limit</span><span class="p">)]</span>
          <span class="k">else</span>
            <span class="nx">c</span>

    <span class="nv">self   = </span><span class="k">this</span>
    <span class="nv">brk    = </span><span class="nx">@get_option</span><span class="p">(</span><span class="s">&#39;break&#39;</span><span class="p">)</span>
    <span class="nv">fn     = </span><span class="nx">brk</span> <span class="o">&amp;&amp;</span> <span class="nx">breakFn</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">brk</span><span class="p">,</span> <span class="nx">@get_option</span><span class="p">(</span><span class="s">&#39;last&#39;</span><span class="p">))</span>
    <span class="nv">result = </span><span class="p">[]</span>
    <span class="nv">index  = </span><span class="mi">0</span>
    
    <span class="nv">oldProperties = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">COLLECTION_HELPER_TAGS</span>
      <span class="nx">oldProperties</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>
    
    <span class="nx">c</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(el) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>We add some helper tags to the scope for each element in the collection
<code>&lt;pop:first&gt;</code>, <code>&lt;pop:last&gt;</code>, <code>&lt;pop:odd&gt;</code> and <code>&lt;pop:even&gt;</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">self.scope.first = </span><span class="nx">index</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nv">self.scope.last  = </span><span class="nx">index</span> <span class="o">==</span> <span class="nx">c</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="nv">self.scope.odd   = </span><span class="nx">index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1"># index is zero based</span>
      <span class="nv">self.scope.even  = </span><span class="nx">index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>
      <span class="nv">value = </span><span class="nx">self</span><span class="p">.</span><span class="nx">render_value</span><span class="p">(</span><span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">value_wrapper</span> <span class="k">then</span> <span class="nx">self</span><span class="p">.</span><span class="nx">value_wrapper</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">self</span><span class="p">)</span> <span class="k">else</span> <span class="nx">el</span><span class="p">)</span>
      <span class="nv">value = </span><span class="k">if</span> <span class="nx">fn</span> <span class="k">then</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="k">else</span> <span class="nx">value</span>
      <span class="nx">index</span><span class="o">++</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span> <span class="nx">value</span>
  
    <span class="k">for</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">CONSTANTS</span><span class="p">.</span><span class="nx">COLLECTION_HELPER_TAGS</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">oldProperties</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;undefined&quot;</span>
        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">oldProperties</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>

    <span class="nx">result</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>When the tag value in the current scope is an object, we look for a .html
function and otherwise use the result of calling toString on the object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render_object: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">if</span> <span class="nx">obj</span> <span class="o">||</span> <span class="nx">obj</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="nx">@has_children</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">@enclosing</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span> <span class="k">then</span> <span class="nx">obj</span> <span class="k">else</span> <span class="p">{</span><span class="nv">value: </span><span class="nx">obj</span><span class="p">})</span>
      <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="s">&#39;html&#39;</span> <span class="k">of</span> <span class="nx">obj</span>
        <span class="nv">value = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">html</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">html</span><span class="p">.</span><span class="nx">call</span> <span class="k">then</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">html</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">@render_options</span><span class="p">())</span> <span class="k">else</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">html</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">value</span> <span class="o">or</span> <span class="p">(</span><span class="k">if</span> <span class="nx">value</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">value</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

      <span class="k">return</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">escape</span> <span class="o">==</span> <span class="s">&quot;false&quot;</span> <span class="k">then</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="k">else</span> <span class="nx">escapeHtml</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>When the value is a function we make a wrapper around the options, the scope and the enclosing tags
and call the function with the wrappers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render_function: </span><span class="nf">(value) -&gt;</span>
    <span class="nv">options = </span><span class="nx">@render_options</span><span class="p">()</span>

    <span class="nv">self = </span><span class="k">this</span>
    <span class="nv">enclosing_wrapper =</span>
      <span class="nv">render: </span><span class="o">-&gt;</span>
        <span class="vi">@rendered = </span><span class="kc">true</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">enclosing</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">enclosing</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
      <span class="nv">skip: </span><span class="o">-&gt;</span>
        <span class="vi">@rendered = </span><span class="kc">true</span>
      <span class="nv">tags: </span><span class="nf">(filter) -&gt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">tags</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span>

    <span class="vi">@scope.lookup = </span><span class="nf">(name) -&gt;</span>
      <span class="nv">tag = </span><span class="nx">self</span>
      <span class="k">while</span> <span class="nx">tag</span>
        <span class="k">return</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="k">if</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
        <span class="nv">tag = </span><span class="nx">tag</span><span class="p">.</span><span class="nx">parent</span>
      
      <span class="k">return</span> <span class="kc">undefined</span>

    <span class="nv">result = </span><span class="nx">value</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@_tag_fn_scope</span> <span class="o">||</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">enclosing_wrapper</span><span class="p">,</span> <span class="nx">@scope</span><span class="p">)</span>
    <span class="nv">result = </span><span class="nx">@value_wrapper</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@value_wrapper</span>
    <span class="k">if</span> <span class="nx">enclosing_wrapper</span><span class="p">.</span><span class="nx">rendered</span> <span class="k">then</span> <span class="nx">result</span> <span class="k">else</span> <span class="nx">@render_value</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>When the value is true or false it is used to conditinally determine if any
enclosed tags should be rendered.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render_boolean: </span><span class="nf">(value) -&gt;</span>
    <span class="k">if</span> <span class="nx">@enclosing</span><span class="p">.</span><span class="nx">is_empty</span><span class="p">()</span>
      <span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span>
      <span class="nx">@enclosing</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">@scope</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@default_value</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">@default_value</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Render the tag with a value. Dispatches to one of the above functions based on
the type of value.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render_value: </span><span class="nf">(value) -&gt;</span>
    <span class="k">return</span> <span class="nx">@render_collection</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">||</span> <span class="nx">@default_value</span><span class="p">()</span> <span class="k">if</span> <span class="nx">value</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">forEach</span>
    <span class="k">return</span> <span class="nx">@render_boolean</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>  <span class="k">if</span> <span class="nx">value</span> <span class="o">==</span> <span class="kc">true</span> <span class="o">or</span> <span class="nx">value</span> <span class="o">==</span> <span class="kc">false</span>
    <span class="k">return</span> <span class="nx">@render_function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="k">if</span> <span class="nx">value</span> <span class="o">and</span> <span class="nx">value</span><span class="p">.</span><span class="nx">call</span>

    <span class="nv">val = </span><span class="nx">@render_object</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
    <span class="nx">val</span> <span class="o">or</span> <span class="p">(</span><span class="k">if</span> <span class="nx">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">val</span> <span class="k">else</span> <span class="nx">@default_value</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Render a region of a layout with a block or the default output of the region.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render_region: </span><span class="nf">(block) -&gt;</span>
    <span class="nx">wrap</span><span class="p">(</span>
      <span class="nx">@with_filters</span><span class="p">((</span><span class="k">if</span> <span class="nx">block</span> <span class="k">then</span> <span class="nx">block</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">@scope</span><span class="p">)</span> <span class="k">else</span> <span class="nx">@enclosing</span><span class="p">.</span><span class="nx">render</span><span class="p">()),</span> <span class="nx">@options</span><span class="p">),</span>
      <span class="nx">@get_option</span><span class="p">(</span><span class="s">&#39;wrap&#39;</span><span class="p">),</span>
      <span class="nx">@get_option</span><span class="p">(</span><span class="s">&#39;class&#39;</span><span class="p">)</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Apply any filters specified in the options to a value</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">with_filters: </span><span class="nf">(value) -&gt;</span>
    <span class="k">if</span> <span class="nx">@filters</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span> <span class="nx">filter</span> <span class="k">in</span> <span class="nx">@filters</span>
        <span class="nv">value = </span><span class="nx">filter</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">@render_options</span><span class="p">())</span>
    <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Render the tag with a scope</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render: </span><span class="nf">(scope) -&gt;</span>
    <span class="vi">@scope = </span><span class="nx">scope</span> <span class="o">||</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Handle the logic for <pop:no_ tags</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@no_tag</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@no_tag</span> <span class="o">==</span> <span class="nx">@parent</span><span class="p">.</span><span class="nx">last_empty</span>
        <span class="nx">wrap</span><span class="p">(</span>
          <span class="nx">@with_filters</span><span class="p">(</span><span class="nx">@enclosing</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">@scope</span><span class="p">),</span> <span class="nx">@options</span><span class="p">),</span>
          <span class="nx">@get_option</span><span class="p">(</span><span class="s">&#39;wrap&#39;</span><span class="p">),</span>
          <span class="nx">@get_option</span><span class="p">(</span><span class="s">&#39;class&#39;</span><span class="p">)</span>
        <span class="p">)</span>
      <span class="k">else</span>
        <span class="s">&#39;&#39;</span>
    <span class="k">else</span>
      <span class="vi">@parent.last_empty = </span><span class="kc">null</span>

    <span class="k">if</span> <span class="nx">@include_tag</span> <span class="o">&amp;&amp;</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">render</span>
      <span class="nv">template_name = </span><span class="nx">@options</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">@scope</span><span class="p">)</span>
      <span class="vi">@enclosing = </span><span class="k">new</span> <span class="nx">Template</span><span class="p">(</span>
        <span class="nv">name: </span><span class="nx">template_name</span>
        <span class="nv">read: </span><span class="nx">@read</span>
        <span class="nv">require: </span><span class="nx">@require</span>
        <span class="nv">filters: </span><span class="nx">@ast</span><span class="p">.</span><span class="nx">filters</span>
        <span class="nv">value_wrapper: </span><span class="nx">@value_wrapper</span>
      <span class="p">).</span><span class="nx">compile</span><span class="p">()</span>
      <span class="vi">@enclosing.parent = </span><span class="k">this</span>

    <span class="k">if</span> <span class="nx">@layout_tag</span> <span class="o">&amp;&amp;</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">render</span>
      <span class="nv">layout_name = </span><span class="nx">@options</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">@scope</span><span class="p">)</span>

      <span class="vi">@enclosing = </span><span class="k">new</span> <span class="nx">Template</span><span class="p">(</span>
        <span class="nv">name: </span><span class="s">&quot;layouts/</span><span class="si">#{</span><span class="nx">layout_name</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nv">read: </span><span class="nx">@read</span>
        <span class="nv">require: </span><span class="nx">@require</span>
        <span class="nv">filters: </span><span class="nx">@ast</span><span class="p">.</span><span class="nx">filters</span>
        <span class="nv">value_wrapper: </span><span class="nx">@value_wrapper</span>
      <span class="p">).</span><span class="nx">compile</span><span class="p">()</span>
      <span class="vi">@enclosing.parent = </span><span class="k">this</span>

    <span class="k">return</span> <span class="nx">@enclosing</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">@scope</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@include_tag</span> <span class="o">||</span> <span class="nx">@layout_tag</span> <span class="o">||</span> <span class="nx">@block_tag</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">render_region</span><span class="p">(</span><span class="nx">@get_block</span><span class="p">())</span> <span class="k">if</span> <span class="nx">@region_tag</span>

    <span class="nx">wrap</span><span class="p">(</span>
      <span class="nx">@with_filters</span><span class="p">(</span><span class="nx">@render_value</span><span class="p">(</span><span class="nx">@get_value</span><span class="p">()),</span> <span class="nx">@options</span><span class="p">),</span>
      <span class="nx">@get_option</span><span class="p">(</span><span class="s">&#39;wrap&#39;</span><span class="p">),</span>
      <span class="nx">@get_option</span><span class="p">(</span><span class="s">&#39;class&#39;</span><span class="p">)</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <h3>Template</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>The public inteface to PopTags.
Options are:
   read: (name) -> templateString
   require: (name) -> CommonJS module exports object
   template: "template string"
   name: "name-of-template-to-render"
   filters: {attribute: (value, options) -> filteredValue}
   value_wrapper: {wrap: (value, tag) -> wrappedValue}</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Template</span>
  <span class="nv">constructor: </span><span class="nf">(options) -&gt;</span>
    <span class="vi">@read     = </span><span class="nx">options</span><span class="p">.</span><span class="nx">read</span>
    <span class="vi">@require  = </span><span class="nx">options</span><span class="p">.</span><span class="nx">require</span>
    <span class="vi">@template = </span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
    <span class="vi">@name     = </span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span>
    <span class="vi">@filters  = </span><span class="nx">options</span><span class="p">.</span><span class="nx">filters</span>
    <span class="vi">@value_wrapper  = </span><span class="nx">options</span><span class="p">.</span><span class="nx">value_wrapper</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Parse the template and return the root node of the AST.
Useful if doing multiple renders of the same template.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compile: </span><span class="o">-&gt;</span>
    <span class="nv">ast = </span><span class="k">new</span> <span class="nx">Ast</span><span class="p">(</span><span class="nx">@require</span><span class="p">,</span> <span class="nx">@filters</span><span class="p">,</span> <span class="nx">@value_wrapper</span><span class="p">)</span>
    <span class="k">new</span> <span class="nx">Parser</span><span class="p">(</span><span class="nx">@read</span><span class="p">).</span><span class="nx">parse</span><span class="p">(</span><span class="nx">@template</span><span class="p">,</span> <span class="nx">ast</span><span class="p">,</span> <span class="nx">@name</span><span class="p">)</span>
    <span class="nx">ast</span><span class="p">.</span><span class="nx">root</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Compile and render a template with a given scope</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render: </span><span class="nf">(scope) -&gt;</span> <span class="nx">@compile</span><span class="p">().</span><span class="nx">render</span><span class="p">(</span><span class="nx">scope</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Export Template and TemplateError</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="nx">exports</span><span class="o">?</span>
  <span class="nv">exports.Template = </span><span class="nx">Template</span>
  <span class="nv">exports.TemplateError = </span><span class="nx">TemplateError</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Make sure PopTags works in the browser as well</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="nb">window</span><span class="o">?</span>
  <span class="nb">window</span><span class="p">.</span><span class="nv">PopTags = </span><span class="p">{</span><span class="nv">Template: </span><span class="nx">Template</span><span class="p">,</span> <span class="nv">escapeHtml: </span><span class="nx">escapeHtml</span><span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 